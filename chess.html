<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tech4U Chess | Bot & Online</title>
    <!-- We need these two libraries for the game to work -->
    <script src="https://cdn.jsdelivr.net/npm/playroomkit"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <style>
        body { background: #0a0b10; color: white; font-family: sans-serif; text-align: center; margin: 0; padding: 0; }
        .board { 
            display: grid; grid-template-columns: repeat(8, 1fr); 
            width: 95vw; max-width: 380px; height: 95vw; max-height: 380px; 
            margin: 10px auto; border: 4px solid #333; background: #222;
        }
        .square { display: flex; align-items: center; justify-content: center; font-size: 30px; cursor: pointer; }
        .white-sq { background: #dee3e6; color: #222; }
        .black-sq { background: #8ca2ad; color: #222; }
        .selected { background: #ffeb3b !important; border: 2px solid orange inset; }
        #ui-layer { padding-top: 40px; }
        .btn { 
            background: #00d4ff; color: black; border: none; padding: 15px; 
            font-size: 18px; font-weight: bold; border-radius: 10px; cursor: pointer; margin: 10px; width: 80%; max-width: 300px;
        }
        .btn-bot { background: #a855f7; color: white; }
        .hidden { display: none !important; }
        #status { color: #00d4ff; margin: 10px; font-weight: bold; height: 20px; }
    </style>
</head>
<body>

    <div id="ui-layer">
        <h1>Tech4U Chess</h1>
        <p>Choose Game Mode:</p>
        <button class="btn" onclick="startOnline()">üåê PLAY ONLINE</button>
        <button class="btn btn-bot" onclick="startBot()">ü§ñ PLAY VS BOT</button>
    </div>

    <div id="game-layer" class="hidden">
        <div id="status">Your Turn (White)</div>
        <div class="board" id="board"></div>
        <button onclick="location.reload()" style="background:none; color:#555; border:1px solid #333; padding:5px; margin-top:20px;">Main Menu</button>
    </div>

    <script>
        const { insertCoin, myPlayer, setState, getState } = Playroom;
        let game = new Chess();
        let isBotMode = false;
        let selectedSquare = null;

        // --- 1. START MODES ---
        async function startOnline() {
            document.getElementById('ui-layer').classList.add('hidden');
            document.getElementById('game-layer').classList.remove('hidden');
            document.getElementById('status').innerText = "Connecting...";

            try {
                // FIXED: Removed complex settings that cause GitHub errors
                await insertCoin({ gameId: "lSO33kfiKxPFBkaFheob" });
                
                document.getElementById('status').innerText = "Online: " + myPlayer().getProfile().name;
                
                // Keep board in sync with other player
                setInterval(() => {
                    const fen = getState("fen");
                    if (fen && fen !== game.fen()) {
                        game.load(fen);
                        drawBoard();
                    }
                }, 1000);

            } catch (e) {
                console.log(e);
                alert("Multiplayer Error. Switching to Bot Mode.");
                startBot();
            }
        }

        function startBot() {
            isBotMode = true;
            document.getElementById('ui-layer').classList.add('hidden');
            document.getElementById('game-layer').classList.remove('hidden');
            document.getElementById('status').innerText = "Vs Tech4U Bot";
            drawBoard();
        }

        // --- 2. BOT LOGIC ---
        function botMove() {
            const moves = game.moves();
            if (game.game_over()) return;
            
            // Random move bot
            const move = moves[Math.floor(Math.random() * moves.length)];
            game.move(move);
            drawBoard();
            document.getElementById('status').innerText = "Your Turn";
        }

        // --- 3. BOARD LOGIC ---
        function drawBoard() {
            const boardDiv = document.getElementById('board');
            boardDiv.innerHTML = '';
            const board = game.board();

            for (let r = 0; r < 8; r++) {
                for (let c = 0; c < 8; c++) {
                    const square = board[r][c];
                    const pos = String.fromCharCode(97 + c) + (8 - r);
                    const sqDiv = document.createElement('div');
                    sqDiv.className = `square ${(r + c) % 2 === 0 ? 'white-sq' : 'black-sq'}`;
                    
                    if (selectedSquare === pos) sqDiv.classList.add('selected');
                    
                    if (square) {
                        const pieces = {
                            'p': '‚ôü', 'r': '‚ôú', 'n': '‚ôû', 'b': '‚ôù', 'q': '‚ôõ', 'k': '‚ôö',
                            'P': '‚ôô', 'R': '‚ôñ', 'N': '‚ôò', 'B': '‚ôó', 'Q': '‚ôï', 'K': '‚ôî'
                        };
                        sqDiv.innerText = pieces[square.type];
                        sqDiv.style.color = (square.color === 'w') ? "#fff" : "#000";
                    }

                    sqDiv.onclick = () => {
                        if (selectedSquare === null) {
                            if (game.get(pos) && game.get(pos).color === game.turn()) {
                                selectedSquare = pos;
                                drawBoard();
                            }
                        } else {
                            const move = game.move({ from: selectedSquare, to: pos, promotion: 'q' });
                            if (move) {
                                if (!isBotMode) setState("fen", game.fen()); // Sync to online player
                                selectedSquare = null;
                                drawBoard();
                                
                                if (isBotMode && !game.game_over()) {
                                    document.getElementById('status').innerText = "Bot is thinking...";
                                    setTimeout(botMove, 600);
                                }
                            } else {
                                selectedSquare = null;
                                drawBoard();
                            }
                        }
                    };
                    boardDiv.appendChild(sqDiv);
                }
            }
        }
    </script>
</body>
</html>
